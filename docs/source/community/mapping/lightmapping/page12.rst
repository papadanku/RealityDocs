
Testing Light & Lightmap Settings
=================================

Before you go any further we should do some test lightmaps on some of our statics to ensure that everything is working as it should be and the settings are good.

First thing to do is unhide your Overgrowth Layer/Objects and if they don't have the leaf material applied to them its best to do that now, or at the very latest just before you render them.

.. note::

   Its worth noting you can alternatively Freeze the layer which will have the same affect as removing its material and increasing FPS.

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000194.jpg

Generally you want to pick a few large buildings with interiors etc and also some objects that trees will be casting shadows on, and some objects with point lights. Also if there are any objects your unsure about if you have set their lightmap size correctly you should include them in this test render. Just select the LOD0 of each of these objects.

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000195.jpg

Then go to **BF2 > BF2** Lightmapping and first we need to set folders for the tools to save our lightmaps in. First set a folder for your temp files, which is what the lightmaps generated by max will be saved into, I would recommend making a folder called ``Temp`` inside the same folder as your lightmapping scene, and then do the same for ``Output`` with making another ``Output`` folder for that:

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000196.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000197.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000198.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000199.jpg

Once that is done and with your test objects selected, hit the **Render Selected Objects** button and it should render your selected objects:

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000200.jpg

Once your lightmaps have finished rendering you will have a bunch of ``.tga`` files for each object lod you have generated:

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000429.jpg

Now its time to convert them to ``.dds`` so that BF2 can read them.

   #. Browse to your ``\Autodesk\3ds Max 9\Scripts\bf2`` folder

      There you will find a ``~convert.bat``

   #. Open up that file with a text editor

      In it you should see this code:

      .. code-block::

         @echo off
         "E:\Program Files (x86)\Autodesk\3ds Max 9\scripts\bf2\bin\extern\nvdxt.exe" -file "F:\My Documents\3dsmax\scenes\Project Reality\Statics\Afghan Compound Buildings v3\LM_Tests\Renders\Temp\*.tga" -dxt1a -outdir "F:\My Documents\3dsmax\scenes\Project Reality\Statics\Afghan Compound Buildings v3\LM_Tests\Renders\Output"

It's now a matter of just changing these paths to match the files on your computer, with the first one just changing it to where you have 3DsMax9 and the PR\:BF2 Max Tools installed, then for the second one ending in ``\Temp\*.tga``, changing that to your map's lightmaps' ``Temp`` folder you crated above, and then finally changing the last path ending in ``\Output`` to the location of your maps lightmaps output folder you created above

   .. note::

      You can make your output folder your levels ``/lightmaps/objects/`` folder, but I would advise against this since you may overwrite some lightmaps you may have wished not to and far safer to do it manually).

   Mine ends up looking like this:

   .. code-block::

      @echo off
      "E:\Program Files (x86)\Autodesk\3ds Max 9\scripts\bf2\bin\extern\nvdxt.exe" -file "F:\My Documents\3dsmax\scenes\Project Reality\LightMaps\Jamaica\Temp\*.tga" -dxt1a -outdir "F:\My Documents\3dsmax\scenes\Project Reality\LightMaps\Jamaica\Output"

After you have done that, run the ``.bat`` script and a little ``cmd.exe`` window should pop up, showing you which files its currently converting. This may take some time if you've got a lot of files to convert.

Once that has finished, browse to your maps lightmaps **Output** folder you set above and in there you should now see a bunch of ``.dds`` images, one for each lod of each static:

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000431.jpg

Copy all of these into your "\\pr_edit\\levels\\*YOUR MAP*\\Lightmaps\\Objects" folder and load up your map with the BF2 Editor and you should now see your lightmaps in your map.    Here are the results of my test lightmaps:

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000205.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000206.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000207.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000208.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000209.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000210.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000211.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000212.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000213.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000214.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000215.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000216.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000217.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000218.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000219.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000220.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221.jpg

It is also important to look at the textures themselves as they can tell you a lot:

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221b.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221d.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221c.jpg

.. note::

   - Each lightmap channel has its purpose.

      - **Green:** Sun
      - **Blue:** Sky
      - **Red:** Point

   - Note the top of the first image which is the Sky of the big building with the trees on its patio thing:

      - Wou can see on the top left of the texture, which is its roof, that there is a shadow around that little extra roof bit on top
      - You can hardly see ingame, but the subconscious does notice this thing if it is not there

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221e.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221f.jpg

.. image:: https://media.realitymod.com/tutorials/Adv_3DsMax_LMing/Adv_3DsMax_LMing_000221g.jpg

There have been two main changes I've made from this testing. The first was to increase the lightmap texture size of the ``citybuilding_3a/b`` from ``128 64 32 16`` to ``256 128 64 32`` since its shadows had quite a few errors etc, and to also increase the multiplier of the Lighthouse's Omni Light to ``2`` from ``1`` since it was not quite powerful enough.

Once you are happy with your light settings and you have tested any changes you have made then you can begin to lightmap your objects fully.
